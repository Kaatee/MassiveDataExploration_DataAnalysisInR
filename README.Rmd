---
title: "Eksploracja Masywnych Danych - projekt 1 - Analiza danych"
author: "Katarzyna Jóźwiak 127237, Piotr Pawlaczyk 127245"
output:
  html_document: 
   toc: true
   theme: united
  md_document: 
   toc: true
---
data wygenerowania: '`r format(Sys.Date(), "%Y-%B-%d")`'

# Podsumowanie badań
***[TODO]*** podsumowanie calego raportu

# Wykorzystane biblioteki
Do analizy danych i stworzenia raportu z tej analizy zostały wykorzystane następujące biblioteki: 
- datasets    
- corrplot  
- ggplot2  
- gganimate  
- dplyr  
- gridExtra  
- gifski package
- imputeTS

# Zapewnienie powtarzalności wyników przy każdym uruchomieniu raportu na tych samych danych
Aby zapewnić powtarzalność próbkowań i losowań liczb (m. inn. przy próbkowaniu zbioru) przy każdym odpaleniu programu ustawiono stałe ziarno.  
```{r}
set.seed(23)
```

# Wstęp
W podanym sprawozdaniu użyto zbioru danych sledzie.csv pobranego ze strony http://www.cs.put.poznan.pl/alabijak/emd/projekt/sledzie.csv . 
Zbiór ten opisuje rozmiary śledzi i warunki, w których żyją od 60-ciu lat. Kolejne kolumny w zbiorze danych to:  
* **length**: długość złowionego śledzia [cm];  
* **cfin1**: dostępność planktonu [zagęszczenie Calanus finmarchicus gat. 1];  
* **cfin2**: dostępność planktonu [zagęszczenie Calanus finmarchicus gat. 2];  
* **chel1**: dostępność planktonu [zagęszczenie Calanus helgolandicus gat. 1];  
* **chel2**: dostępność planktonu [zagęszczenie Calanus helgolandicus gat. 2];  
* **lcop1**: dostępność planktonu [zagęszczenie widłonogów gat. 1];  
* **lcop2**: dostępność planktonu [zagęszczenie widłonogów gat. 2];  
* **fbar**: natężenie połowów w regionie [ułamek pozostawionego narybku];  
* **recr**: roczny narybek [liczba śledzi];  
* **cumf**: łączne roczne natężenie połowów w regionie [ułamek pozostawionego narybku];  
* **totaln**: łączna liczba ryb złowionych w ramach połowu [liczba śledzi];  
* **sst**: temperatura przy powierzchni wody [°C];  
* **sal**: poziom zasolenia wody [Knudsen ppt];  
* **xmonth**: miesiąc połowu [numer miesiąca];  
* **nao**: oscylacja północnoatlantycka [mb].  
Wiersze w zbiorze są uporządkowane chronologicznie.

# Wczytywanie danych z pliku
```{r}
names <- read.table("sledzie.csv", nrow=1, stringsAsFactors = FALSE, sep = ",")
data <- read.table("sledzie.csv", header=TRUE, stringsAsFactors = FALSE, sep=",")
head(data)
```
Jak widać, wczytane dane zawierają znak "?" przy nieznanych danych.

Wyświetlenie klas poszczególnych kolumn:
```{r}
sapply(data, class)
```
Dane zawierające znak "?" zostały zinterpretowane jako tekst.
Zmiana "?" na "NA" wraz ze zmianą typu danych z character na numeric:
```{r}
data[data=="?"] <- NA
```
Po zmianie znaku "?" na wartość NA zmianiono typ danych kolumn z nieznanymi wartościami na wartości numeryczne.  
```{r}
data$cfin1 <- as.numeric(data$cfin1)
data$cfin2 <- as.numeric(data$cfin2)
data$chel1 <- as.numeric(data$chel1)
data$chel2 <- as.numeric(data$chel2)
data$lcop1 <- as.numeric(data$lcop1)
data$lcop2 <- as.numeric(data$lcop2)
data$sst <- as.numeric(data$sst)

head(data)
sapply(data, class)

```
***[TODO]*** może to jakoś ładniej zrobić "as.numeric" a nie tak brzydko powtarzając kod

# Rozmiar zbioru danych i podstawowe statystyki
```{r}
paste("Wczytane dane zawierają ", nrow(data), " rekordów oraz ", ncol(data), " kolumn.", sep=" ")
```

Podsumowanie wartości danych:
```{r}
summary(data)
```

Ilość brakujących danych dla poszczególnych kolumn:
```{r}
missingData <- sapply(data, function(x) sum(is.na(x)))
missingData
```
Wykres ilości brakujących danych w zbiorze:

```{r}
plot(x = factor(names(missingData)), y = missingData, main="Wykres ilości brakujących danych w zbiorze", xlab="atrybut", ylab = "ilość brakujących artybutów")
```  

Jak widać zbiór danych zawiera znaczną ilość brakujących danych, co może utrudnić ich późniejszą analizę.

# Brakujące dane
```{r}
library("imputeTS")
data$cfin1 <- na_kalman(data$cfin1)
data$cfin2 <- na_kalman(data$cfin2)
data$chel1 <- na_kalman(data$chel1)
data$chel2 <- na_kalman(data$chel2)
data$lcop1 <- na_kalman(data$lcop1)
data$lcop2 <- na_kalman(data$lcop2)
data$sst <- na_kalman(data$sst)
```

Ilosć brakujących danych w poszczególnych kolumnach po zastosowaniu filtru Kalman'a:

```{r}
missingData <- sapply(data, function(x) sum(is.na(x)))
missingData
```
# Szczegółowa analiza zbiorów wartości
Poniżej przedstawiono rozkłady wszystkich wartośi w zbiorze danych  

***[TODO]*** Zrobić te wykresy troche szersze i wyższe  

```{r cache=TRUE}
library(ggplot2)
library(ggExtra)

lengthDissPlot <- ggplot(data, aes(x=length)) + geom_histogram(binwidth=.5, colour="black", fill="white")
cfin1DissPlot <- ggplot(data, aes(x=cfin1)) + geom_histogram(binwidth=1, colour="black", fill="white")
cfin2DissPlot <- ggplot(data, aes(x=cfin2)) + geom_histogram(binwidth=1, colour="black", fill="white")
chel1DissPlot <- ggplot(data, aes(x=chel1)) + geom_histogram(binwidth=.5, colour="black", fill="white")
chel2DissPlot <- ggplot(data, aes(x=chel2)) + geom_histogram(binwidth=.5, colour="black", fill="white")
lcop1DissPlot <- ggplot(data, aes(x=lcop1)) + geom_histogram(binwidth=.5, colour="black", fill="white")
lcop2DissPlot <- ggplot(data, aes(x=lcop2)) + geom_histogram(binwidth=.5, colour="black", fill="white")
fbarDissPlot <- ggplot(data, aes(x=fbar)) + geom_histogram(binwidth=.05, colour="black", fill="white")
recrDissPlot <- ggplot(data, aes(x=recr)) + geom_histogram(binwidth=50000.0, colour="black", fill="white")
cumfDissPlot <- ggplot(data, aes(x=cumf)) + geom_histogram(binwidth=.02, colour="black", fill="white")
totalnDissPlot <- ggplot(data, aes(x=totaln)) + geom_histogram(binwidth=1000.0, colour="black", fill="white")
sstDissPlot <- ggplot(data, aes(x=sst)) + geom_histogram(binwidth=1.0, colour="black", fill="white")
salDissPlot <- ggplot(data, aes(x=sal)) + geom_histogram(binwidth=.01, colour="black", fill="white")
xmonthDissPlot <- ggplot(data, aes(x=xmonth)) + geom_histogram(binwidth=1.0, colour="black", fill="white")
naoDissPlot <- ggplot(data, aes(x=nao)) + geom_histogram(binwidth=.5, colour="black", fill="white")


require(gridExtra)
grid.arrange(lengthDissPlot,cfin1DissPlot,cfin2DissPlot ,chel1DissPlot ,chel2DissPlot,lcop1DissPlot,lcop2DissPlot ,fbarDissPlot ,
recrDissPlot ,cumfDissPlot ,totalnDissPlot ,sstDissPlot ,salDissPlot ,xmonthDissPlot ,naoDissPlot, nrow = 5, ncol=3)
```

Z powyższych wykresów wynika, że jeśli chodzi o rozkład poszczególnych atrybutów to zbiór nie jest zrównoważony.  

Analizując długość śledzia (*length*) można zauważyć, że ten atrybut przyjmuje rozkład zbliżony do rozkładu normalnego. W zbiorze danych znajduje się najwięcej śledzi o długości równej 25-26cm. Ze wcześniejszej analizy podsumowującej dane wynika także, że minimalna długość śledzia w zbiorze to 19cm, a maksymalna to 32.5cm. Średnia długość 25.3cm, a mediana to 25,5.  

Jeśli chodzi o atrybut jakim jest dostępność planktonu (zarówno zagęszczenie *Calanus finmarchicus gat. 1* jak i *Calanus finmarchicus gat. 2*) to można zauważyć że w zbiorze znalazło się znacznie więcej danych z łowisk o mniejszej dostępności planktonu omawianego gatunku. Minimalna dostępność pierwszego gatunku tego planktonu to 0, maksymalna: ok 37,67. Srednia to ok. 0,45 a mediana to ok. 0,11. Jeśli chodzi o drugi gatunek planktonu *Calanus finmarchicus* to jego minimalne zagęszczenie wynosi 0, maksymalne - ok. 19,4, średnia to ok. 2,03 a mediana - 0.7.  

***[TODO]*** Opisać reszte  
***[TODO]*** Moze cos z odstającymi danymi - najlepiej zapytac na zajeciach

# Korelacja między zmiennymi

W niniejszej sekcji została przeanalizowana korelacja między atrybutami.Na początek przedstawiono współczynniki korelacji wraz z graficzną macierzą korelacji.  

Największa korelacja występuje między atrybutem *chel1* i *lcop1* - czyli między dostępnością planktonu dwóch gatunków i wynosi ona 0.96. Między *chel2* i *lcop2* - współczynnik korelacji wynosi 0.89, a między *cumf* ( łączne roczne natężenie połowów w regionie) a *fbar* (natężenie połowów w regionie): 0.82 (zależność między tymi ostatnimi wynika prawdopodobnie z tego, że na podstawie jednego z tych atrybutów w naturalny sposób oblicza się dtugi z nich). Wysoka korelacja występuje także między *cfin2* a *lcop2*, gdzie współczynnik korelacji jest równy 0.65.  

Bardzo niski, jednak ujemny współczynnik korelacji (wynoszący -0.55) miedzy atrybutem *lcop1* a *neo* (oscylacja północnoatlantycka) świadczy o wysokiej, ale odwrotnej zaleznosci tych atrybutów. Może to być wyjaśnione z punktu widzenia przyrody przez to, że plankton może być przenoszony przez prądy morskie.  

Niski ujemny współczynnik korelacji wskazujący na wysoką korelacje atrybutów można też zauważyć między *cumf* (łączne roczne natężenie połowów w regionie) a *totaln* (łączna liczba ryb złowionych w ramach połowu) - wynosi on -0.71, gdzie taka zależność też jest naturalna.  

Jeśli chodzi o atrybut, którego będą dotyczyć badania w dalszej części pracy, czyli ługość śledzia, to jest najbardziej skorelowana z temperaturą przy powierzchni wody, a współczynnik tej korelacji wynosi -0.45 (czyli są to wartości odwrotnie zależne)

***[TODO]*** Zmniejszyć tekst w srodku zeby bylo widac  

```{r cache=TRUE}
res <- cor(data)
#round(res, 2)

library(corrplot)
corrplot.mixed(res, tl.col = "black", tl.srt = 45)
```

Żeby lepiej zwizualizować korelacje między omówionymi atrybutami przedstawiono wykresy zależności tych atrybutów.

```{r cache=TRUE}
plot(data[,c(5,7,16)])
```

W przypadku zaprezentowanych powyżej danych, zgodnie z wartościami mieszczącymi się w macierzy korelacji, największą korelacje (współczynnik korelacji wynoszący 0.96) widać między dostępnością planktonu pierwszego gatunku Calanus helgolandicus (*chel1*) a zagęszczeniem widłonogów z gatunku pierwszego (*lcop2*). Z wykresu wynika, że im więcej jednego plantonu w łowisku, tym spotkać tam można więcej drugiego z wymienionych planktonów.  
Zależność między *lcop2* a  oscylacja północnoatlantycka  *neo* nie jest aż tak widoczna na wykresie (choć też da się ją zauważyć).  


```{r cache=TRUE}
plot(data[,c(6,8,4)])
```

Podobnie jak na poprzednim wykresie, i tu najbardziej widoczna jest korelacja między dostępnością dwóch z gatunków planktonu.

```{r cache=TRUE}
plot(data[,c(9,11,12)])
```

Na powyższym wykresie korelacji najbardziej widać odwrotnie proporcjonalną zależność między *fbar* a *totaln* - współczynnik korelacjiwynoszący -0.71) i *cumf* a *totaln*. Można wyraźnie zauważyć że im więcej pierwszego z atrybutów, tym mniej drugiego i odwrotnie.  
Wysoce proporcjonalne są zmienne *fbar* i *cumf*.

```{r cache=TRUE}
plot(data[,c(2,13)])
```

***[TODO]*** Nie mam pojęcia jak opisać ten wykres, jak sie nie dowiem to wywalić :P

# Zmiana rozmiaru śledzia w czasie

```{r}
library(ggplot2)
library(gganimate)
library(dplyr)

p <- ggplot(
  data, aes(X, length, group = xmonth, color = factor(xmonth))) +
  geom_line() +
  scale_color_viridis_d() +
  labs(x = "Kolejne połowy", y = "Dlugosc sledzia") +
  theme(legend.position = "top")

```

```{r}
p + geom_point() + transition_reveal(X)
```

***[TODO]*** pobawic sie w pogrupowanie tych miesiecy w pory roku zeby nie bylo tak brzydko na wykresie

# Przewidywanie rozmiaru śledzia
W niniejszej sekcji zostanie podjęta próba stworzenia regresora przewidującego rozmiar śledzia.  
***[TODO]*** ogarnąć te regresory    
***[TODO]*** Sekcję próbującą stworzyć regresor przewidujący rozmiar śledzia (w tej sekcji należy wykorzystać wiedzę z pozostałych punktów oraz wykonać dodatkowe czynności, które mogą poprawić trafność predykcji); dobór parametrów modelu oraz oszacowanie jego skuteczności powinny zostać wykonane za pomocą techniki podziału zbioru na dane uczące, walidujące i testowe; trafność regresji powinna zostać oszacowana na podstawie miar R2 i RMSE

# Analiza ważnośći atrybutów najlepszego znalezionego modelu regresji  
***[TODO]*** Analiza ważności atrybutów najlepszego znalezionego modelu regresji. Analiza ważności atrybutów powinna stanowić próbę odpowiedzi na pytanie: co sprawia, że rozmiar śledzi zaczął w pewnym momencie maleć.
